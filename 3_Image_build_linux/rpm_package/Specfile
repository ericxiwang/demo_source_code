%define name nginxdemo
%define product_base %{PRODUCT_BASE}
%define version %{VERSION}
%define _unpackaged_files_terminate_build 0
# Disable all post processing, including jar repacking
%global __os_install_post %{nil}

Name: %{name}

RELEASE: %{product_base}
VERSION: %{version}
Summary: Nginx RPM binary build demo
Group: Development/Tools
License: Eric Wang
Packager: Eric Wang <gowest.wang@gmail.com>
Requires: make
Requires(pre): /usr/sbin/useradd /usr/bin/systemctl
Requires(post): /usr/bin/systemctl
Autoreq: 0
Autoprov: 0

%description
Nginx Binary build by eric wang

%pre

# Add the nginx user
getent group nginxdemo >/dev/null || groupadd -g 1007 -r nginxdemo
getent passwd nginxdemo >/dev/null || \
        useradd -r -u 1007 -g nginxdemo -s /sbin/nologin \
        -d /tmp -c "nginxdemo" nginxdemo
      exit 0
echo 'nginxdemo ALL=(ALL) NOPASSWD:/bin/systemctl start nginx,/bin/systemctl stop nginx,/bin/systemctl restart nginx' > /etc/sudoers.d/nginxdemo
echo 'nginxdemo ALL=(ALL) NOPASSWD:/usr/bin/apt-get remove,/usr/bin/dpkg' >> /etc/sudoers.d/nginxdemo

%post
/usr/bin/systemctl daemon-reload
/usr/bin/systemctl enable nginx
echo "======== change nginx config ====="
get_hostname=$(hostname)
sed -i s/"nginx!"/$get_hostname/g /usr/share/nginx/html/index.html
%preun


%postun
if [ $1 = 0 ]; then
        /usr/bin/systemctl daemon-reload
fi

%files
%defattr(-,nginxdemo,nginxdemo,-)
/data/XXXXX/images/uploaded
/data/XXXXX/images/camera
/data/XXXXX/images/captioned
/data/XXXXX/images/detected
/data/XXXXX/images/meters/uploaded
/data/XXXXX/videos/camera
/data/XXXXX/videos/uploaded
/data/XXXXX/videos/captioned
/data/XXXXX/videos/searched
/data/XXXXX/models
/preserve/logs
%config(noreplace) /etc/nginx/conf.d/default.conf
%config(noreplace) /etc/nginx/nginx.conf
%config(noreplace) /etc/logrotate.d/nginx

